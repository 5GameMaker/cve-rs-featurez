#![deny(unsafe_code)]
#![deny(clippy::pedantic)]
#![deny(clippy::nursery)]

// The actual exploit
mod lifetime_expansion;

// The bugs we created with the exploit
mod buffer_overflow;
mod segfault;
mod transmute;
mod use_after_free;

pub use buffer_overflow::buffer_overflow;
pub use lifetime_expansion::*;
pub use segfault::segfault;
pub use transmute::transmute;
pub use use_after_free::use_after_free;

pub fn extend_lifetime<'a, T>(x: &'a T) -> &'static T {
	fn exploit<'a, 'b, T>(_: &'a &'b (), v: &'b T) -> &'a T {
		v
	}
	static UNIT: &'static &() = &&();
	let f: fn(_, &'a T) -> &'static T = exploit;
	f(UNIT, x)
}

pub fn extend_lifetime_mut<'a, T>(x: &'a mut T) -> &'static mut T {
	fn exploit_mut<'a, 'b, T>(_: &'a &'b (), v: &'b mut T) -> &'a mut T {
		v
	}
	static UNIT: &'static &() = &&();
	let f: fn(_, &'a mut T) -> &'static mut T = exploit_mut;
	f(UNIT, x)
}
